# WordPressのレガシーテーマをPHP8系対応にした話

## はじめに
今回紹介するのは、PHPやWordPressに踏み込んだ技術的な話ではなく、第三者が開発した詳細不明プロジェクトを早急にカバーする事態になった際にAIを使った応急措置（エラーハンドリング）方法です。
ここでいう「早急にカバーする事態」とは対象サイトまたはサービスにアクセスすると真っ白で何も表示されない、つまり「サイトダウンしている事態」を指します。

**本来こういった事態にならないよう一般的にはCI/CDや監視ツール、社内ワークフローなどできちんとコントロールすべき**です。
しかしながら、人的資源や知見の乏しい弊社のような環境もあるのではと思い、以下のような対象読者を想定して記事にしていきます。

### 対象読者
- テストコードや詳細情報が無い中で緊急性の高い対応を求められている方やチーム
- フロント側（例：開発者ツールのConsoleパネル内）にエラー情報が出ておらず途方に暮れている初学者
- HTML,CSS,JSは学んだものの、サーバーサイドについて少し苦手意識のある方
- AIを用いたデバッグ方法や問題究明、課題解決に興味のある方
- AIの利活用において無料ユーザーを貫いている方

### 結論： 情報・状況把握して、それらをAIに投げて壁打ちしながら仮説出し及びコード改修を進める
先にも書きましたが、こういった事態にならないよう**一般的にはCI/CDや監視ツール、社内ワークフローなどできちんとコントロールすべき**です。
そして普段からこまめにメンテナンスやバックアップを取っておくなど予防的措置も効果的です。

以下はこうした予防措置フェーズを超えて、実害発生フェーズに入っている状況で話を進めます。

最も大事なのは**まずは落ち着いて情報・状況把握する**ことです。
詳しくは後述しますが、AIを活用するには**AIに提供するための情報がかなり大事**になってきます。

その次に大事になるのが、自分の知識や経験を総動員して**問題の発生源を考えて（仮説を出して）、いくつかの可能性を箇条書きでも良いので言語化**しておくことです。
しかし現実的には、時間上の制約や問題の切り分け方法、実際の開発環境、クライアントの事情など複合的な要因で「仮説出し及び言語化」に時間が取れないケースもあるかと思います。

こういった現実的対処を素早く行う上では「**情報・状況把握して、それらをAIに投げて壁打ちしながら仮説出し及びコード改修を進める**」という方法が、今回の筆者の場合はうまくはまりました。

---

ちなみに、今回の筆者のケースはこのように発生しました。
原因としては「PHP8系に準拠した記述になっていなかったり、非推奨の関数やメソッドを使っていたりした」ことです。

1. 社内にて、紙媒体専門デザイナーに対してweb開発にチャレンジするようお達しが出る
2. WordPressサイトを開発し、 **既存WPサイトのサブディレクトリにホスティング及びサーバー設定を調整したところ、既存サイト内の一つがサイトダウン**した
    - 補足：既存WPサイトは多言語サイトで、今回デザイナーが開発した新規サイト含めて合計9つのWPサイトが一つのドメイン配下に設置されているトンデモ仕様です
3. 筆者が定期メンテナンスで確認した際にサイトダウンしていることが発覚

さらに余談ながら上長報告した際、筆者は初めて今回デザイナーが制作していることを知りました。
筆者確認の3日前にホスティングしたそうで**最低でも3日間もサイトダウンしており、その間に誰も把握できていなかった**ということになります。

## サイトが真っ白になって──
まずは開発者ツールのログ（Consoleパネル）を確認したのですが何もエラーや警告が表示されておらず、ネットワークパネルにも別段変なところはありませんでした。
しかしElementsパネルでDOMツリーを確認したところ**`body`内に何もレンダリングされていなかった**のです。
サーバーを見に行くと数日前に見慣れないディレクトリが追加されていることに気づき、一瞬マルウェアとかの類かドキッとしたのですが中身をみるとWordPressサイトのようでした。

::: note info
- 補足：
実は、今回のサイトダウンに関して原因に思い当たる節がありました。
以前、テスト環境用サーバーのPHPを7系から8系にアップグレードした際に一部サイトが同様の事態になったのです。
これはPHP8系に準拠した記述になっていなかったり、非推奨の関数やメソッドを使っていたりするのが原因でした。
こういった点でこまめにチェックする予防的措置は（実施や習慣化は面倒ですが）効果的です。

この際に、上長には詳細を伝えており「今後の対応を考える」という返答で対応保留となっていました。
:::

上長にサイトがダウンしている状態を伝えたところ、上長も思い当たる節があるようでした。
そこで一旦、以前に伝えたテスト環境で起きたことの再報告と、知らないWordPressサイトが追加されていることを報告。
すると、デザイナーがWordPress開発しており数日前にホスティングした事実を伝えられました。

### ことの起こり（顛末）
デザイナーのWordPressサイトは（当然ながら）最新のPHP8系で作られており、それをホスティングしたところ「PHPのバージョンが古いから更新してね！」という通知が出てきて、それに従って更新したようです。
この際、 **上長判断および上長が操作のもとサーバーパネルで当該サブディレクトリのみをPHP7系から8系にアップグレード**したといいます。
すると実は、 **サーバー内でPHPが7系から8系にすべて自動的にアップグレード**されていて、9つあるうちの1つが落ちていた。という顛末です。

上長の考えでは「サブディレクトリだけアップグレードしたので当然そこだけがPHP8系になると思っていた」ということだそうです。
今となっては真相は闇の中ですが、もしかすると操作を間違えて全体アップグレードしてしまっていたのかもしれません。

### 取り急ぎグレードダウンして対応
落ちているサイトはクライアント側でもぼちぼち使っているものだったので取り急ぎPHPを7系に戻しました。
無事に落ちているサイトも表示されるようになったのですが、一つのサイトだけのためにPHPを7系のまま運用していくのも良くないです。

そこで上長は「特にSEOが重視されているようなサイトでもなかったので、当該サイトのみ別ドメインを取得してPHP7系で運用する」という現実的な判断を下しました。
ただしこれでは根本的解決には至っていないですし、そのサイトの無理な延命処置のためにドメイン費用や通知に関する手間などコストがかかるのが少し嫌だったのです。

そこで、タイトルにあるようにテーマをPHP8系に準ずる改修作業を行うことにしました。

### 情報・状況把握を行う
サイトダウンした改修対象サイトの詳細は以下です。

#### サイトの詳細情報
- 10年ほど前に[`BizVektor`](https://bizvektor.com/info/bizvektor-v-1-12-0/)という`Lightning`の前身？テーマをもとに作成
    - ※子テーマとしておらず、当該テーマの中身を別途複製した別テーマとして作成している
- 外部ベンダーが一部開発を請け負っており、そこが提供する機能との兼ね合いでサイトの大規模リファクタリング・修正などは厳しい
- 開発者は既に退職していて当然ドキュメントなど必要情報もない（あっても使用プラグインの説明など）
- `BizVektor`の開発は2018年で止まっている（※`Lightning`に移行推奨を通知してくれていた）

::: note info
今回、不幸中の幸いで原因がある程度は判明しているものでしたが、AIへの情報提供において整理しておくのは重要です。
:::

#### サイトダウンした原因
`BizVektor`テーマの中身を別途複製してオリジナルテーマとした「別テーマ（`tondemo-theme`）」がPHP8系に対応できていなかった。

### AIに投げて壁打ちしながら仮説出し及びコード改修を進める
※筆者は無料ユーザーなので以下のようなことをしていますが、有料ユーザーの場合はClaude CodeやGitHub Copilotを存分に利用したりしてもっとスムーズに解決できると思います。そのため、以下は無料ユーザー向けの知見共有となります。

---

今回、GitHub Copilotと共に進めながら、途中でブラウザ版のClaudeを使用しました。
理由はどちらも無料ユーザーであるためです。

まずGitHub Copilotに、先にあげたサイトの詳細情報のほか、これまでの経緯やテスト環境での出来事を伝えて、並行してテーマの全体像を把握してもらいました。

この時に意識したのはプロンプトで以下をお願いすることです。

```
- ステップバイステップでフェーズを考えて、フェーズごとのタスクを想定および選定して
- フェーズが変わるタイミングやタスク実施時は随時確認して
- 不明点があれば作業を止めて聞いて
```

今回の対応がそこまで複雑なケースではなかったのか、結構こんなプロンプトでも期待通りに働いてくれました。

最初の問題検知フェーズで、Copilotが原因となるPHP8系に準じていないファイルやコードの選定を行ってくれました。
その次に、具体的な解決策（タスク想定および選定）を行ってくれて、この際に根本原因（非推奨な書き方）と対応方法も提示してくれました。

余談ながらフェーズごとに分離していないと、この段階で壁打ちしてコード理解やプロジェクト構造理解を進めたくとも情報が埋もれて精度が下がってしまう不安があります。
しかし今回は作業をフェーズごとに分けているので安心して壁打ちできました。

（この壁打ちのせいで無料枠を使い切ってしまい、途中でブラウザ版のClaudeに頼ることになりました）

存分に壁打ちしたら、あとは次のフェーズに移って各タスクを実行してもらうだけです。

今回、筆者の場合は途中でブラウザ版のClaudeと進めることになりました。
それでもClaudeに、GitHub Copilotに渡した情報とGitHub Copilotが提示してくれた情報やタスク割り、必要ファイルの情報をはじめ、先のプロンプトでお願いすると、スムーズに作業以降ができました。

サイトは3日ほど落ちていましたが、実対応にかかった時間で言えば3〜4時間ほどで完了しました（そのうちコード改修に至っては30分〜1時間半程度）。

---

AIがいなければ、上長判断の「当該サイトのみ別ドメインを取得してPHP7系で運用する」という現実的だが良くない選択になっていたと思います。
これだけ短期間で対応できたのはAIの力はもちろんですが、それを十分に発揮するには「**情報・状況把握して、それらをAIに投げて壁打ちしながら仮説出し及びコード改修を進める**」ことが大事だと強く実感しました。

## 最後に
正直、書いていて恥ずかしい部分も多く、内容的にも「やらかしカレンダー」に掲載しようか迷いました。
