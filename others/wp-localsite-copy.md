# 本番環境サイトをLocalへ移行する手順

1. `All in one migration`プラグインを使用する（※容量制限があるので注意）
   - [All-in-One WP Migrationの容量を上げる方法とバックアップ](https://www.caliberelectronics.com/all-in-one-wp-migration/)
   - [All-in-One WP Migrationでインポートする容量が大きすぎる時の対処法](https://wapufure.com/wordpress-all-in-one-wp-migration-import-large/)<br>
   ファイルを分割したり、FTP経由にしたり、有料版を購入したりして必要データ・ファイルをダウンロードする

2. **非推奨**：容量制限に抵触したり、それ以外の理由でどうしても方法が無かったりする場合の代替アプローチ

> [!NOTE]
> 今から説明する方法は非推奨です。最終手段としてください

---

### 必要素材
- 対象（本環境）サイトの **DB（`***.sql`）**、 **`wp-contents`フォルダ**、 **`wp-config.php`ファイル**
- ローカルサイト（`local`で事前に**対象（本環境）サイトのミラーサイトを作成**しておく。設定は後ほど上書きされるので適当に最新verで進めてok）

### 具体的な手順
- 1：ホスティング会社（例：エックスサーバー）のサーバー管理パネル（の`phpMyAdmin`）または`BackWPup`などバックアッププラグイン経由でサイトから **対象（本環境）サイトのDB（`***.sql`）をエクスポート（ダウンロード）** してバックアップを取得

- 2：事前準備していたローカルサイトの「DB（`local.sql` | 所在パス：`/localサイト名/app/sql`）」をデスクトップなど管理しやすい場所にコピー（※バックアップ意図）<br>
※以下「A：コピーDB（`local.sql`）」と「B:対象（本環境）サイトのDB（`***.sql`）」とします。
   - この2つのDBファイルを VSCode などエディタで開く
   - `com / ctrl + Fキー`で検索窓を開いて`wp_options`と入力し、サイト情報関連のセクション（※`'siteurl'`や`'home'`, `'blogname'`, `'admin_email'`などが目印）を検出する
      - Bを編集対象として、**対象（本環境）サイトのドメインになっている部分をローカルサイトのドメインに全置換**する<br>
      このタイミングでユーザーアドレスやサイト名、サイトディスクリプションなども変更しておく

- 3：`local`のサーバー管理パネル（`AdminNeo（Adminer）`）から**現DB（`local.sql`）の全テーブルを削除して中身を空にする**
  - ※`AdminNeo（Adminer）`は、当該ローカルサイトをアクティベートした後に右側パネルのダッシュボードにある「`Database`タブ -> `Open AdminNeo`」で開くことができる

- 4：2で調整した「対象（本環境）サイトのDB（`***.sql`）」を、`local`のサーバー管理パネル（`AdminNeo（Adminer）`）からローカルサイトへインポート

- 5：対象（本環境）サイトの`wp-contents`フォルダと`wp-config.php`ファイルを、ローカルサイトの`wp-contents`フォルダと`wp-config.php`ファイルに置き換える

---

これで反映できるはずですが見ての通り工数が多く、作業において懸念の多い部分（直接`.sql`ファイルを触ったり）もありますのでおすすめできる方法ではありません。

> [!NOTE]
> - 上記と逆パターン（ローカルサイト -> 本番環境）の場合は以下ページを参照してください（※方法はほぼ同じです）<br>
> [WordPressの本番公開について](https://qiita.com/zima_web05/questions/e6e19b04aca498612f36#answer-d12266321a556e5882a1)

---

> [!NOTE]
> `get_xxxx`と`the_xxxx`のエスケープ処理について
> - `get_xxxx`関数は「値を取得」する仕様<br>
>   `get_`を前置するテンプレートタグは、値を取得（返す）という仕様のため`echo`（出力）する場合は**必ずエスケープ処理が必要**となる。
> - `the_xxxx`関数は「値を出力（表示）」する仕様<br>
>   `the_`を前置するテンプレートタグは、`WordPress`が`echo`（出力）するテンプレートタグ（**適切にエスケープされて出力される**）なので安全に使用できる。<br><br>
> ※何らかの出力を行う際は極力`the_xxxx`関数を使用するのが無難。
> - `the_xxxx`関数にはエスケープ処理が不要！
> - `get_xxxx`関数には`echo`する場合はエスケープ処理が必要となる。
> ```php
> echo esc_{url, attr, html...などなど}(get_field('フィールド名'));
> ```
